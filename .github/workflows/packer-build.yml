name: Packer Build

# NOTE: The build job requires a self-hosted runner with network access to both:
# 1. Proxmox API (for VM creation)
# 2. The VM's private IP (for SSH provisioning)
# GitHub-hosted runners CANNOT reach private homelab networks.
# Set up a self-hosted runner with the 'proxmox' label, or run Packer locally.

on:
  workflow_dispatch:
    inputs:
      template:
        description: 'Packer template to build'
        required: true
        default: 'ubuntu-2404-server'
        type: choice
        options:
          - ubuntu-2404-server
      run_build:
        description: 'Run Packer build (requires self-hosted runner)'
        required: true
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - 'packer/**'
  pull_request:
    paths:
      - 'packer/**'

env:
  PACKER_VERSION: "1.10.0"

jobs:
  validate:
    name: Validate Packer Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Format Check
        run: packer fmt -check -recursive packer/

      - name: Packer Init
        run: packer init .
        working-directory: packer/proxmox/ubuntu-2404-server

      - name: Packer Validate (syntax only)
        run: packer validate -syntax-only .
        working-directory: packer/proxmox/ubuntu-2404-server

      - name: Summary
        if: always()
        run: |
          echo "## Packer Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Template: ubuntu-2404-server" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Requirements" >> $GITHUB_STEP_SUMMARY
          echo "Packer builds require network access to both Proxmox API and VM private IPs." >> $GITHUB_STEP_SUMMARY
          echo "GitHub-hosted runners cannot reach private homelab networks." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Options:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Set up a self-hosted runner with 'proxmox' label in your homelab" >> $GITHUB_STEP_SUMMARY
          echo "2. Run Packer locally from a machine with network access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local Build:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'cd packer/proxmox/ubuntu-2404-server' >> $GITHUB_STEP_SUMMARY
          echo 'packer init . && packer build -var-file=secrets.pkrvars.hcl .' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # IMPORTANT: This job requires a self-hosted runner with network access to:
  # - Proxmox API (for VM creation/management)
  # - VM private IPs (for SSH provisioning)
  # GitHub-hosted runners CANNOT reach private homelab networks.
  build:
    name: Build Packer Image (Self-Hosted)
    runs-on: proxmox
    needs: validate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_build == 'true'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y xorriso unzip zip curl wget
          elif command -v brew &> /dev/null; then
            brew install xorriso unzip || true
          fi

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Init
        run: packer init .
        working-directory: packer/proxmox/${{ github.event.inputs.template }}

      - name: Pre-flight Network Diagnostics
        run: |
          echo "=== Self-hosted Runner Network Info ==="
          echo "Hostname: $(hostname)"
          echo "IP addresses:"
          ip -4 addr show | grep -E 'inet ' || hostname -I
          echo ""
          echo "=== Testing Proxmox API connectivity ==="
          # Extract host from URL
          PROXMOX_HOST=$(echo "${{ secrets.PROXMOX_API_URL }}" | sed 's|https\?://||' | cut -d':' -f1 | cut -d'/' -f1)
          echo "Proxmox host: $PROXMOX_HOST"
          if ping -c 1 -W 5 "$PROXMOX_HOST" > /dev/null 2>&1; then
            echo "✓ Proxmox host is reachable"
          else
            echo "✗ WARNING: Cannot ping Proxmox host (may be blocked by firewall)"
          fi
          echo ""
          echo "=== Firewall Status ==="
          sudo iptables -L INPUT -n 2>/dev/null | head -20 || echo "Cannot check iptables"

      - name: Packer Build
        run: |
          packer build -force \
            -var "proxmox_api_url=${{ secrets.PROXMOX_API_URL }}" \
            -var "proxmox_api_token_id=${{ secrets.PROXMOX_API_TOKEN_ID }}" \
            -var "proxmox_api_token_secret=${{ secrets.PROXMOX_API_TOKEN_SECRET }}" \
            -var "ssh_password=${{ secrets.PACKER_SSH_PASSWORD }}" \
            .
        working-directory: packer/proxmox/${{ github.event.inputs.template }}
        env:
          HCP_CLIENT_ID: ${{ secrets.HCP_CLIENT_ID }}
          HCP_CLIENT_SECRET: ${{ secrets.HCP_CLIENT_SECRET }}
          HCP_PROJECT_ID: ${{ secrets.HCP_PROJECT_ID }}
          PACKER_LOG: 1

      - name: Summary
        if: always()
        run: |
          echo "## Packer Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Template: ${{ github.event.inputs.template }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- HCP Packer Registry: Enabled" >> $GITHUB_STEP_SUMMARY
