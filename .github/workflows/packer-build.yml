name: Packer Validate

# Simplified workflow: Validation only
# Actual builds run directly on Proxmox host via: make packer-remote-build
#
# Why? Packer needs direct network access to both:
# - Proxmox API (for VM creation)
# - VM private IPs (for SSH provisioning)
# Running Packer directly on Proxmox avoids all network routing issues.

on:
  push:
    branches: [main, development]
    paths:
      - 'packer/**'
  pull_request:
    paths:
      - 'packer/**'
  workflow_dispatch:

env:
  PACKER_VERSION: "1.12.0"

jobs:
  validate:
    name: Validate Packer Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Format Check
        run: packer fmt -check -recursive packer/

      - name: Packer Init
        run: |
          for template in packer/proxmox/*/; do
            if [ -f "$template"/*.pkr.hcl ]; then
              echo ">>> Initializing $template"
              packer init "$template"
            fi
          done

      - name: Packer Validate
        run: |
          for template in packer/proxmox/*/; do
            if [ -f "$template"/*.pkr.hcl ]; then
              echo ">>> Validating $template"
              packer validate -syntax-only "$template"
            fi
          done

      - name: Summary
        if: always()
        run: |
          echo "## Packer Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Template | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          for template in packer/proxmox/*/; do
            name=$(basename "$template")
            if [ -f "$template"/*.pkr.hcl ]; then
              echo "| $name | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Build" >> $GITHUB_STEP_SUMMARY
          echo "Run Packer directly on Proxmox host:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'make packer-remote-build TEMPLATE=ubuntu-2404-server' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
