name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      stack:
        description: 'Terraform stack to deploy'
        required: true
        type: choice
        options:
          - 01-infrastructure
          - 02-kubernetes
          - 03-platform
          - 04-applications
      action:
        description: 'Terraform action'
        required: true
        type: choice
        default: 'plan'
        options:
          - plan
          - apply
      use_self_hosted:
        description: 'Use self-hosted runner (required for Proxmox access)'
        required: false
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - 'terraform/**'
  pull_request:
    paths:
      - 'terraform/**'

env:
  TERRAFORM_VERSION: "1.7.0"

jobs:
  validate:
    name: Validate All Stacks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        stack:
          - 01-infrastructure
          - 02-kubernetes
          - 03-platform
          - 04-applications
    defaults:
      run:
        working-directory: terraform/stacks/${{ matrix.stack }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Summary
        if: always()
        run: |
          echo "## Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Stack: ${{ matrix.stack }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Local Execution" >> $GITHUB_STEP_SUMMARY
          echo "For plan/apply, Terraform Cloud must have network access to Proxmox." >> $GITHUB_STEP_SUMMARY
          echo "If using Terraform Cloud's remote execution, configure an agent in your homelab." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To run locally:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'cd terraform/stacks/${{ matrix.stack }}' >> $GITHUB_STEP_SUMMARY
          echo 'export TF_CLOUD_ORGANIZATION="your-org"' >> $GITHUB_STEP_SUMMARY
          echo 'terraform init' >> $GITHUB_STEP_SUMMARY
          echo 'terraform plan' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  plan:
    name: Terraform Plan
    runs-on: ${{ github.event.inputs.use_self_hosted == 'true' && fromJSON('["self-hosted", "proxmox"]') || 'ubuntu-latest' }}
    needs: validate
    if: github.event_name == 'workflow_dispatch'
    environment: production
    defaults:
      run:
        working-directory: terraform/stacks/${{ github.event.inputs.stack }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        env:
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
          TF_VAR_proxmox_api_token_id: ${{ secrets.PROXMOX_API_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ secrets.PROXMOX_API_TOKEN_SECRET }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          TF_VAR_cluster_ca_certificate: ${{ secrets.CLUSTER_CA_CERTIFICATE }}
          TF_VAR_cluster_token: ${{ secrets.CLUSTER_TOKEN }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_letsencrypt_email: ${{ secrets.LETSENCRYPT_EMAIL }}
          TF_VAR_vault_license: ${{ secrets.VAULT_LICENSE }}

      - name: Summary
        if: always()
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Stack: ${{ github.event.inputs.stack }}" >> $GITHUB_STEP_SUMMARY
          echo "- Organization: Configured via TF_CLOUD_ORGANIZATION secret" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  apply:
    name: Terraform Apply
    runs-on: ${{ github.event.inputs.use_self_hosted == 'true' && fromJSON('["self-hosted", "proxmox"]') || 'ubuntu-latest' }}
    needs: plan
    if: github.event.inputs.action == 'apply'
    environment: production
    defaults:
      run:
        working-directory: terraform/stacks/${{ github.event.inputs.stack }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve
        env:
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
          TF_VAR_proxmox_api_token_id: ${{ secrets.PROXMOX_API_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ secrets.PROXMOX_API_TOKEN_SECRET }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          TF_VAR_cluster_ca_certificate: ${{ secrets.CLUSTER_CA_CERTIFICATE }}
          TF_VAR_cluster_token: ${{ secrets.CLUSTER_TOKEN }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_letsencrypt_email: ${{ secrets.LETSENCRYPT_EMAIL }}
          TF_VAR_vault_license: ${{ secrets.VAULT_LICENSE }}

      - name: Summary
        if: always()
        run: |
          echo "## Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Stack: ${{ github.event.inputs.stack }}" >> $GITHUB_STEP_SUMMARY
          echo "- Action: Apply" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
