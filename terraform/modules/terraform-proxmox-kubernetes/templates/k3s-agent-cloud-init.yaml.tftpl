#cloud-config
# K3s Agent (Worker): ${node_name}

package_update: true
package_upgrade: true

packages:
  - curl
  - jq
  - open-iscsi
  - nfs-common
  - apparmor
  - apparmor-utils

write_files:
  - path: /etc/rancher/k3s/config.yaml
    permissions: '0644'
    owner: root:root
    content: |
      node-name: "${node_name}"
      server: "https://${server_ip}:6443"
      token: "${k3s_token}"
      kubelet-arg:
        - "max-pods=110"

  - path: /opt/k3s/install-k3s-agent.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -euo pipefail

      echo "=== Starting K3s agent installation on ${node_name} ==="

      mkdir -p /etc/rancher/k3s

      echo "Waiting for control plane at ${server_ip}:6443..."
      for i in $(seq 1 60); do
        if curl -sk -o /dev/null -w '%%{http_code}' "https://${server_ip}:6443/readyz" 2>/dev/null | grep -qE "^(200|401|403)$"; then
          echo "Control plane is ready!"
          break
        fi
        echo "Attempt $i/60 - waiting 10s..."
        sleep 10
      done

      echo "Installing K3s agent ${k3s_version}..."
      curl -sfL https://get.k3s.io | \
        INSTALL_K3S_VERSION="${k3s_version}" \
        sh -s - agent

      sleep 15

      echo "=== K3s agent installation complete on ${node_name} ===" | logger -t k3s-init

runcmd:
  - /opt/k3s/install-k3s-agent.sh
